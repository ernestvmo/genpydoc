name: PR - Run package (Poetry) + propose changes

on:
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  run-and-propose-changes:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        python-version: [ "3.11" ]

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          # Checkout the PR's head branch (the "current branch" for this PR)
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "1.8.3"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      - name: Run package (may modify files)
        run: poetry run python -m genpydoc --target-branch main

      # Optional but helpful: fail fast if package left unformatted, etc.
      # - name: Run tests/lint
      #   run: poetry run pytest -q

      - name: Create PR with any generated changes
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Create a branch specifically for these generated changes
          branch: bot/pr-${{ github.event.pull_request.number }}-generated
          delete-branch: true

          # IMPORTANT: target the PR's current branch as the base
          base: ${{ github.head_ref }}

          commit-message: "chore: genpydoc-generated documentation"
          title: "chore: genpydoc-generated documentation for PR #${{ github.event.pull_request.number }}"
          body: |
            This PR contains changes generated by running `python -m genpydoc . --target-branch main` in CI.
            It targets the current PR branch (`${{ github.head_ref }}`) so it can be merged into the PR.
          labels: |
            automated
          # Only opens/updates a PR when there are file changes
          # (Action does nothing if working tree is clean)
