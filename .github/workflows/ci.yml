name: Run genpydoc + PR changes

on:
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  run-and-propose-changes:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        python-version: [ "3.11" ]

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Fetch base branch and create local ref
        run: |
          git fetch --no-tags --prune origin "${{ github.base_ref }}"
          git branch --force "${{ github.base_ref }}" "origin/${{ github.base_ref }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install project (PEP 621)
        run: |
          python -m pip install --upgrade pip
          # Editable install so "python -m your_package" works from the repo checkout
          pip install -e .

      - name: Run package (may modify files)
        run: python -m genpydoc . --target-branch "${{ github.base_ref }}"

      # Optional but helpful: fail fast if package left unformatted, etc.
      # - name: Run tests/lint
      #   run: poetry run pytest -q

      - name: Create PR with any generated changes
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Create a branch specifically for these generated changes
          branch: bot/pr-${{ github.event.pull_request.number }}-generated
          delete-branch: true

          # IMPORTANT: target the PR's current branch as the base
          base: ${{ github.head_ref }}

          commit-message: "chore: genpydoc-generated documentation"
          title: "chore: genpydoc-generated documentation for PR #${{ github.event.pull_request.number }}"
          body: |
            This PR contains changes generated by running `python -m genpydoc . --target-branch main` in CI.
            It targets the current PR branch (`${{ github.head_ref }}`) so it can be merged into the PR.
          labels: |
            automated
          # Only opens/updates a PR when there are file changes
          # (Action does nothing if working tree is clean)
